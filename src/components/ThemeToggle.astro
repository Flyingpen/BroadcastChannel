---
import moonIcon from '../assets/moon.svg'
import sunIcon from '../assets/sun.svg'
---

<button
  id="theme-toggle"
  class="relative inline-flex h-10 w-10 items-center justify-center rounded-2xl border border-white/20 bg-white/70 text-brand-500 shadow-inner transition hover:-translate-y-0.5 hover:border-brand-400 hover:text-brand-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-brand-400/60 dark:border-white/10 dark:bg-surface-900/70"
  aria-label="Toggle theme"
  title="Toggle theme"
>
  <img id="theme-icon-sun" src={sunIcon.src} alt="Light mode" class="h-5 w-5 transition duration-200" />
  <img id="theme-icon-moon" src={moonIcon.src} alt="Dark mode" class="hidden h-5 w-5 transition duration-200" />
</button>

<script is:inline>
  const THEME_KEY = 'theme'
  const doc = document.documentElement

  function applyTheme(theme) {
    doc.setAttribute('data-theme', theme)
    const sunIcon = document.getElementById('theme-icon-sun')
    const moonIcon = document.getElementById('theme-icon-moon')
    if (!sunIcon || !moonIcon) {
      return
    }

    sunIcon.classList.toggle('hidden', theme === 'dark')
    moonIcon.classList.toggle('hidden', theme !== 'dark')
  }

  function getPreferredTheme() {
    try {
      const stored = localStorage.getItem(THEME_KEY)
      if (stored === 'dark' || stored === 'light') {
        return stored
      }
    } catch {}

    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  }

  function setInitialTheme() {
    doc.classList.add('js-theme-ready')
    applyTheme(getPreferredTheme())
  }

  function toggleTheme() {
    const current = doc.getAttribute('data-theme') === 'dark' ? 'dark' : 'light'
    const next = current === 'dark' ? 'light' : 'dark'
    applyTheme(next)
    try {
      localStorage.setItem(THEME_KEY, next)
    } catch {}
  }

  function setup() {
    setInitialTheme()
    const button = document.getElementById('theme-toggle')
    if (!button) {
      return
    }

    button.addEventListener('click', (event) => {
      event.preventDefault()
      toggleTheme()
    })
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setup, { once: true })
  } else {
    setup()
  }
</script>
