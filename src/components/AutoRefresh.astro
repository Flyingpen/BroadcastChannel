---
// è‡ªåŠ¨åˆ·æ–°ç»„ä»¶ï¼Œç”¨äºé™æ€éƒ¨ç½²æ—¶å®ç°å†…å®¹æ›´æ–°
const { SITE_URL } = Astro.locals
const isProduction = import.meta.env.NODE_ENV === 'production'
const isGitHubPages = import.meta.env.GITHUB_PAGES === 'true'
const isEdgeOne = import.meta.env.SERVER_ADAPTER === 'edgeone'
const isStaticDeployment = isProduction && (isGitHubPages || isEdgeOne)
---

<script>
  // è‡ªåŠ¨åˆ·æ–°é€»è¾‘ï¼Œä»…åœ¨é™æ€éƒ¨ç½²æ—¶å¯ç”¨
  ;(function () {
    const refreshInterval = 300000 // 5åˆ†é’Ÿ
    const siteUrl = window.location.origin
    let lastUpdateCheck = Date.now()
    let isVisible = true

    // æ£€æŸ¥æ˜¯å¦ä¸ºé™æ€éƒ¨ç½²
    const isStatic = document.body.dataset.static === 'true'
    if (!isStatic) {
      return
    }

    // é¡µé¢å¯è§æ€§æ£€æµ‹
    document.addEventListener('visibilitychange', () => {
      isVisible = !document.hidden
      if (isVisible && Date.now() - lastUpdateCheck > refreshInterval) {
        checkForUpdates()
      }
    })

    // æ£€æŸ¥æ›´æ–°å‡½æ•°
    async function checkForUpdates() {
      try {
        // é€šè¿‡ RSS feed æ£€æŸ¥æ˜¯å¦æœ‰æ–°å†…å®¹
        const response = await fetch(`${siteUrl}/rss.xml?_t=${Date.now()}`, {
          cache: 'no-cache',
        })

        if (response.ok) {
          const rssContent = await response.text()
          const parser = new DOMParser()
          const rssDoc = parser.parseFromString(rssContent, 'application/xml')

          // è·å–æœ€æ–°æ–‡ç« çš„å‘å¸ƒæ—¶é—´
          const latestItem = rssDoc.querySelector('item pubDate')
          if (latestItem) {
            const latestPubDate = new Date(latestItem.textContent).getTime()
            const storedLastUpdate = localStorage.getItem('lastContentUpdate')

            if (storedLastUpdate && latestPubDate > Number.parseInt(storedLastUpdate)) {
              // å‘ç°æ–°å†…å®¹ï¼Œæ˜¾ç¤ºåˆ·æ–°æç¤º
              showUpdateNotification()
            } else if (!storedLastUpdate) {
              // é¦–æ¬¡è®¿é—®ï¼Œè®°å½•å½“å‰æœ€æ–°æ—¶é—´
              localStorage.setItem('lastContentUpdate', latestPubDate.toString())
            }
          }
        }
      } catch (error) {
        console.warn('Failed to check for updates:', error)
      }

      lastUpdateCheck = Date.now()
    }

    // æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
    function showUpdateNotification() {
      // é¿å…é‡å¤æ˜¾ç¤ºé€šçŸ¥
      if (document.getElementById('update-notification')) {
        return
      }

      const notification = document.createElement('div')
      notification.id = 'update-notification'
      notification.innerHTML = `
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ff5f1f, #3b82f6);
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        z-index: 10000;
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 300px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.2);
        animation: slideIn 0.3s ease-out;
      ">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
          "></div>
          <div>
            <div style="font-weight: 600; font-size: 14px; margin-bottom: 4px;">
              å‘ç°æ–°å†…å®¹ ğŸ‰
            </div>
            <div style="font-size: 12px; opacity: 0.9;">
              ç‚¹å‡»åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°æ›´æ–°
            </div>
          </div>
        </div>
        <button onclick="location.reload()" style="
          margin-top: 12px;
          background: rgba(255,255,255,0.2);
          border: 1px solid rgba(255,255,255,0.3);
          color: white;
          padding: 8px 16px;
          border-radius: 8px;
          cursor: pointer;
          font-size: 12px;
          font-weight: 500;
          transition: background 0.2s;
          width: 100%;
        " onmouseover="this.style.background='rgba(255,255,255,0.3)'"
           onmouseout="this.style.background='rgba(255,255,255,0.2)'">
          ç«‹å³åˆ·æ–°
        </button>
        <button onclick="this.parentElement.parentElement.remove()" style="
          position: absolute;
          top: 8px;
          right: 8px;
          background: none;
          border: none;
          color: rgba(255,255,255,0.7);
          cursor: pointer;
          font-size: 16px;
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          transition: background 0.2s;
        " onmouseover="this.style.background='rgba(255,255,255,0.2)'"
           onmouseout="this.style.background='none'">
          Ã—
        </button>
      </div>
    `

      // æ·»åŠ åŠ¨ç”»æ ·å¼
      if (!document.getElementById('update-notification-styles')) {
        const style = document.createElement('style')
        style.id = 'update-notification-styles'
        style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }
      `
        document.head.appendChild(style)
      }

      document.body.appendChild(notification)

      // 5ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        if (notification.parentElement) {
          notification.style.animation = 'slideIn 0.3s ease-out reverse'
          setTimeout(() => notification.remove(), 300)
        }
      }, 5000)
    }

    // ç«‹å³æ£€æŸ¥ä¸€æ¬¡ï¼Œç„¶åè®¾ç½®å®šæ—¶æ£€æŸ¥
    setTimeout(checkForUpdates, 5000) // é¡µé¢åŠ è½½5ç§’åé¦–æ¬¡æ£€æŸ¥

    // å®šæœŸæ£€æŸ¥æ›´æ–°ï¼ˆä»…åœ¨é¡µé¢å¯è§æ—¶ï¼‰
    setInterval(() => {
      if (isVisible) {
        checkForUpdates()
      }
    }, refreshInterval)

    // ç›‘å¬ç„¦ç‚¹äº‹ä»¶ï¼Œç”¨æˆ·è¿”å›é¡µé¢æ—¶æ£€æŸ¥æ›´æ–°
    window.addEventListener('focus', () => {
      if (Date.now() - lastUpdateCheck > 60000) {
        // 1åˆ†é’Ÿå†…ä¸é‡å¤æ£€æŸ¥
        setTimeout(checkForUpdates, 1000)
      }
    })
  })()
</script>
